<!DOCTYPE html>
<html lang="es">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <title>Bienvenido - Manejo del Estrés Estudiantil</title>
      <meta name="keywords" content="estrés estudiantil, bienestar, salud mental">
      <meta name="description" content="Aplicación para el manejo del estrés estudiantil">
      <meta name="author" content="">
      <link rel="icon" href="images/fevicon.png" type="image/png" />
      <link rel="stylesheet" href="css/bootstrap.min.css" />
      <link rel="stylesheet" href="style.css" />
      <link rel="stylesheet" href="css/responsive.css" />
      <link rel="stylesheet" href="css/colors.css" />
      <link rel="stylesheet" href="css/bootstrap-select.css" />
      <link rel="stylesheet" href="css/perfect-scrollbar.css" />
      <link rel="stylesheet" href="css/custom.css" />
      <link rel="stylesheet" href="css/custom-colors.css" />
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
      <style>
         :root {
            --primary-color: #2C3E50;
            --secondary-color: #E74C3C;
            --accent-color: #3498DB;
            --text-color: #2C3E50;
            --light-bg: #ECF0F1;
            --areandina-green: #00A859;
            --areandina-orange: #F7941D;
         }

         body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
         }

         .auth-container {
            max-width: 450px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
         }

         .auth-brain-image {
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: auto;
            opacity: 0.15;
            transform: translate(25%, -25%);
            z-index: 0;
         }

         .auth-content {
            position: relative;
            z-index: 1;
         }

         .auth-container h2 {
            color: var(--areandina-green);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
         }

         .auth-logo {
            width: 200px;
            margin-bottom: 30px;
         }

         .auth-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
         }

         .auth-form p {
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
         }

         .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background-color: white;
            color: var(--text-color);
            border: 2px solid var(--areandina-green);
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
            font-weight: 500;
         }

         .google-btn:hover {
            background-color: var(--areandina-green);
            color: white;
            box-shadow: 0 4px 8px rgba(0,168,89,0.2);
         }

         .google-btn:hover img {
            filter: brightness(0) invert(1);
         }

         .google-btn img {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
         }

         .error-message {
            color: var(--secondary-color);
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(231, 76, 60, 0.1);
         }

         .success-message {
            color: var(--areandina-green);
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0, 168, 89, 0.1);
         }

         .auth-footer {
            margin-top: 30px;
            color: #666;
            font-size: 14px;
         }

         #app-content {
            display: none;
         }

         .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
         }

         .user-email {
            color: var(--primary-color);
            font-weight: 500;
         }

         .logout-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
         }

         .logout-btn:hover {
            background-color: rgba(231, 76, 60, 0.1);
         }

         .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 15px 0;
         }

         .divider::before,
         .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #ddd;
         }

         .divider span {
            padding: 0 10px;
            color: #666;
            font-size: 14px;
         }

         .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid var(--areandina-green);
         }

         .notification.error {
            border-left-color: var(--secondary-color);
         }

         .notification i {
            margin-right: 12px;
            font-size: 20px;
         }

         .notification.success i {
            color: var(--areandina-green);
         }

         .notification.error i {
            color: var(--secondary-color);
         }

         .notification-content {
            flex-grow: 1;
         }

         .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-color);
         }

         .notification-message {
            color: #666;
            font-size: 14px;
         }

         @keyframes slideIn {
            from {
               transform: translateX(100%);
               opacity: 0;
            }
            to {
               transform: translateX(0);
               opacity: 1;
            }
         }

         @keyframes fadeOut {
            from {
               transform: translateX(0);
               opacity: 1;
            }
            to {
               transform: translateX(100%);
               opacity: 0;
            }
         }
      </style>
   </head>
   <body class="dashboard dashboard_1">
      <!-- Contenedor de Autenticación -->
      <div id="auth-container" class="auth-container">
         <img src="/images/logo/cerebro.png" alt="Cerebro" class="auth-brain-image">
         <div class="auth-content">
            <img src="https://cms.areandina.edu.co/sites/default/files/styles/large/public/2022-06/header_educontinua_virtual_-_opt.png?itok=9ItxRIJZ" alt="Logo Areandina" class="auth-logo">
            <h2>Espacio de Bienestar Académico</h2>
            <div class="auth-form">
               <p>Inicia sesión con tu cuenta institucional de Areandina (@areandina.edu.co) para acceder a tu espacio de bienestar</p>
               <button onclick="loginWithGoogle()" class="google-btn">
                  <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                  Continuar con Google
               </button>
               <div id="auth-message" class="error-message"></div>
            </div>
            <div class="auth-footer">
               Fundación Universitaria del Área Andina
            </div>
         </div>
      </div>

      <!-- Contenido Principal de la Aplicación -->
      <div id="app-content">
         <div class="full_container">
            <div class="inner_container">
               <!-- Sidebar -->
               <nav id="sidebar">
                  <div class="sidebar_blog_1">
                     <div class="sidebar-header">
                        <div class="logo_section">
                           <a href="index.html"><img class="logo_icon img-responsive" src="https://cms.areandina.edu.co/sites/default/files/styles/large/public/2022-06/header_educontinua_virtual_-_opt.png?itok=9ItxRIJZ" alt="Logo Areandina" /></a>
                        </div>
                     </div>
                     <div class="sidebar_user_info">
                        <div class="icon_setting"></div>
                        <div class="user_profle_side">
                           <div class="user_img"><img class="img-responsive" src="images/layout_img/user_img.jpg" alt="#" /></div>
                           <div class="user_info">
                              <h6>Estudiante</h6>
                              <p><span class="online_animation"></span> En línea</p>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="sidebar_blog_2">
                     <h4>Menú Principal</h4>
                     <ul class="list-unstyled components">
                        <li class="active">
                           <a href="app.html"><i class="fa fa-home yellow_color"></i> <span>Inicio</span></a>
                        </li>
                        <li>
                           <a href="profile.html"><i class="fa fa-user blue1_color"></i> <span>Mi Perfil</span></a>
                        </li>
                        <li>
                           <a href="settings.html"><i class="fa fa-cog yellow_color"></i> <span>Configuración</span></a>
                        </li>
                        <li>
                           <a href="#" onclick="logout()"><i class="fa fa-sign-out yellow_color"></i> <span>Cerrar Sesión</span></a>
                        </li>
                     </ul>
                  </div>
               </nav>
               <!-- end sidebar -->
               <!-- right content -->
               <div id="content">
                  <!-- topbar -->
                  <div class="topbar">
                     <nav class="navbar navbar-expand-lg navbar-light">
                        <div class="full">
                           <button type="button" id="sidebarCollapse" class="sidebar_toggle"><i class="fa fa-bars"></i></button>
                           <div class="logo_section">
                              <a href="app.html"><img class="img-responsive" src="https://cms.areandina.edu.co/sites/default/files/styles/large/public/2022-06/header_educontinua_virtual_-_opt.png?itok=9ItxRIJZ" alt="Logo Areandina" /></a>
                           </div>
                           <div class="right_topbar">
                              <div class="icon_info">
                                 <ul>
                                    <li><a href="#"><i class="fa fa-bell-o"></i><span class="badge">2</span></a></li>
                                    <li><a href="#"><i class="fa fa-question-circle"></i></a></li>
                                 </ul>
                              </div>
                           </div>
                        </div>
                     </nav>
                  </div>
                  <!-- end topbar -->
                  <!-- dashboard inner -->
                  <div class="midde_cont">
                     <div class="container-fluid">
                        <div class="row column_title">
                           <div class="col-md-12">
                              <div class="page_title">
                                 <h2>Bienvenido a tu Espacio de Bienestar</h2>
                              </div>
                           </div>
                        </div>
                        <!-- Sección de Bienvenida -->
                        <div class="row">
                           <div class="col-md-12">
                              <div class="white_shd full margin_bottom_30">
                                 <div class="full graph_head">
                                    <div class="heading1 margin_0">
                                       <h2>¡Hola! Estamos aquí para ayudarte</h2>
                                    </div>
                                 </div>
                                 <div class="full padding_infor_info">
                                    <div class="row">
                                       <div class="col-lg-12">
                                          <p class="lead">Bienvenido a tu espacio personal para el manejo del estrés. Aquí encontrarás herramientas y recursos para ayudarte a mantener un equilibrio saludable entre tus estudios y tu bienestar.</p>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <!-- Opinómetro -->
                        <div class="row">
                           <div class="col-md-6">
                              <div class="white_shd full margin_bottom_30">
                                 <div class="full graph_head">
                                    <div class="heading1 margin_0">
                                       <h2>¿Cómo te sientes hoy?</h2>
                                    </div>
                                 </div>
                                 <div class="full padding_infor_info">
                                    <div class="row">
                                       <div class="col-lg-12">
                                          <div class="form-group">
                                             <select class="form-control" id="mood-selector">
                                                <option value="">Selecciona tu estado de ánimo</option>
                                                <option value="excelente">😊 Excelente</option>
                                                <option value="bien">🙂 Bien</option>
                                                <option value="normal">😐 Normal</option>
                                                <option value="mal">😔 Mal</option>
                                                <option value="terrible">😢 Terrible</option>
                                             </select>
                                          </div>
                                          <!-- Historial de estados de ánimo -->
                                          <div class="mt-3">
                                             <h5>Últimos estados de ánimo:</h5>
                                             <ul class="list-group" id="mood-history">
                                                <!-- El historial se llenará dinámicamente -->
                                             </ul>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                           <!-- Próxima Meta -->
                           <div class="col-md-6">
                              <div class="white_shd full margin_bottom_30">
                                 <div class="full graph_head">
                                    <div class="heading1 margin_0">
                                       <h2>Mi Próxima Meta</h2>
                                    </div>
                                 </div>
                                 <div class="full padding_infor_info">
                                    <div class="row">
                                       <div class="col-lg-12">
                                          <div class="form-group">
                                             <input type="text" class="form-control" id="goal-input" placeholder="¿Cuál es tu próxima meta?">
                                          </div>
                                          <button class="btn btn-primary" id="save-goal">Guardar Meta</button>
                                          <button class="btn btn-danger ms-2" id="clear-goals">Limpiar Metas</button>
                                          <!-- Historial de metas -->
                                          <div class="mt-3">
                                             <h5>Mis Metas:</h5>
                                             <ul class="list-group" id="goal-history">
                                                <!-- El historial se llenará dinámicamente -->
                                             </ul>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <!-- Formulario de Google -->
                        <div class="row">
                           <div class="col-md-12">
                              <div class="white_shd full margin_bottom_30">
                                 <div class="full graph_head">
                                    <div class="heading1 margin_0">
                                       <h2>Cuéntanos más sobre ti</h2>
                                    </div>
                                 </div>
                                 <div class="full padding_infor_info">
                                    <div class="row">
                                       <div class="col-lg-12">
                                          <iframe src="https://docs.google.com/forms/d/1DGiFLEuopUtymMpkPw35UJYSxxXO1VhCy0qI7hoF9ds/viewform?embedded=true" 
                                                  width="100%" 
                                                  height="600" 
                                                  frameborder="0" 
                                                  marginheight="0" 
                                                  marginwidth="0">
                                             Cargando...
                                          </iframe>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Contenedor de Notificaciones -->
      <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

      <!-- jQuery -->
      <script src="js/jquery.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.min.js"></script>
      <!-- wow animation -->
      <script src="js/animate.js"></script>
      <!-- select country -->
      <script src="js/bootstrap-select.js"></script>
      <!-- nice scrollbar -->
      <script src="js/perfect-scrollbar.min.js"></script>
      <script>
         var ps = new PerfectScrollbar('#sidebar');
      </script>
      <!-- custom js -->
      <script src="js/custom.js"></script>
      <script>
         // Funciones para manejar el localStorage
         function saveToLocalStorage(key, value, isCompleted = false) {
             let items = JSON.parse(localStorage.getItem(key) || '[]');
             
             // Si es una meta, agregar el estado de completado
             if (key === 'goals') {
                 items.unshift({
                     id: Date.now(), // Agregar un ID único
                     value: value,
                     date: new Date().toLocaleString(),
                     completed: false // Siempre se crea como no completada
                 });
                 // Mantener solo los últimos 15 items no completados
                 items = items.filter(item => !item.completed).slice(0, 15);
             } else if (key === 'completed_goals') {
                 items.unshift({
                     id: Date.now(), // Agregar un ID único
                     value: value,
                     date: new Date().toLocaleString(),
                     completed: true
                 });
                 // Mantener solo los últimos 15 items completados
                 items = items.slice(0, 15);
             } else {
                 items.unshift({
                     value: value,
                     date: new Date().toLocaleString()
                 });
                 // Mantener solo los últimos 5 items para estados de ánimo
                 items = items.slice(0, 5);
             }
             
             localStorage.setItem(key, JSON.stringify(items));
             return items;
         }

         function getFromLocalStorage(key) {
             return JSON.parse(localStorage.getItem(key) || '[]');
         }

         function updateHistoryDisplay(key, containerId) {
             const items = getFromLocalStorage(key);
             const container = document.getElementById(containerId);
             
             if (key === 'goals') {
                 const completedItems = getFromLocalStorage('completed_goals');
                 const allItems = [...items, ...completedItems];
                 
                 container.innerHTML = allItems.map(item => `
                     <li class="list-group-item d-flex justify-content-between align-items-center ${item.completed ? 'text-muted' : ''}">
                         <div class="d-flex align-items-center">
                             <input type="checkbox" 
                                    class="form-check-input me-2" 
                                    ${item.completed ? 'checked' : ''} 
                                    onchange="toggleGoalCompletion(${item.id}, ${item.completed})">
                             <span style="${item.completed ? 'text-decoration: line-through;' : ''}">${item.value}</span>
                         </div>
                         <small class="text-muted">${item.date}</small>
                     </li>
                 `).join('');
             } else {
                 container.innerHTML = items.map(item => `
                     <li class="list-group-item d-flex justify-content-between align-items-center">
                         <span>${item.value}</span>
                         <small class="text-muted">${item.date}</small>
                     </li>
                 `).join('');
             }
         }

         function toggleGoalCompletion(itemId, isCurrentlyCompleted) {
             const sourceKey = isCurrentlyCompleted ? 'completed_goals' : 'goals';
             const targetKey = isCurrentlyCompleted ? 'goals' : 'completed_goals';
             
             // Obtener las listas actuales
             const sourceItems = getFromLocalStorage(sourceKey);
             const targetItems = getFromLocalStorage(targetKey);
             
             // Encontrar el item a mover
             const itemIndex = sourceItems.findIndex(item => item.id === itemId);
             if (itemIndex === -1) return;
             
             const itemToMove = sourceItems[itemIndex];
             
             // Remover el item de la lista fuente
             sourceItems.splice(itemIndex, 1);
             localStorage.setItem(sourceKey, JSON.stringify(sourceItems));
             
             // Agregar el item a la lista destino con el estado opuesto
             itemToMove.completed = !isCurrentlyCompleted;
             targetItems.unshift(itemToMove);
             
             // Mantener el límite de 15 items
             const updatedTargetItems = targetItems.slice(0, 15);
             localStorage.setItem(targetKey, JSON.stringify(updatedTargetItems));
             
             // Actualizar la visualización
             updateHistoryDisplay('goals', 'goal-history');
         }

         function clearAllGoals() {
             if (confirm('¿Estás seguro que deseas eliminar todas tus metas? Esta acción no se puede deshacer.')) {
                 localStorage.removeItem('goals');
                 localStorage.removeItem('completed_goals');
                 updateHistoryDisplay('goals', 'goal-history');
                 alert('Todas las metas han sido eliminadas.');
             }
         }

         // Inicializar historiales al cargar la página
         document.addEventListener('DOMContentLoaded', function() {
             updateHistoryDisplay('moods', 'mood-history');
             updateHistoryDisplay('goals', 'goal-history');
             
             // Agregar evento al botón de limpiar metas
             document.getElementById('clear-goals').addEventListener('click', clearAllGoals);
         });

         // Script para manejar el guardado de la meta
         document.getElementById('save-goal').addEventListener('click', function() {
             const goal = document.getElementById('goal-input').value;
             if (goal) {
                 saveToLocalStorage('goals', goal, false);
                 updateHistoryDisplay('goals', 'goal-history');
                 document.getElementById('goal-input').value = '';
                 alert('¡Meta guardada con éxito!');
             } else {
                 alert('Por favor, ingresa una meta');
             }
         });

         // Script para manejar el selector de estado de ánimo
         document.getElementById('mood-selector').addEventListener('change', async function() {
            try {
               console.log('=== INICIO DEL EVENTO DE CAMBIO DE ESTADO DE ÁNIMO ===');
               const mood = this.value;
               console.log('Valor seleccionado:', mood);
               
               if (mood) {
                  const moodText = this.options[this.selectedIndex].text;
                  console.log('Texto del estado de ánimo:', moodText);
                  
                  const user = auth.currentUser;
                  if (!user) {
                     throw new Error('No hay usuario autenticado');
                  }
                  
                  console.log('Usuario autenticado:', user.email);
                  console.log('ID del usuario:', user.uid);

                  // Verificar si ya existe un registro para hoy
                  const today = new Date();
                  today.setHours(0, 0, 0, 0);
                  const tomorrow = new Date(today);
                  tomorrow.setDate(tomorrow.getDate() + 1);

                  const existingMood = await db.collection('moods')
                     .where('userId', '==', user.uid)
                     .orderBy('timestamp', 'desc')
                     .limit(1)
                     .get();

                  if (!existingMood.empty) {
                     const lastMood = existingMood.docs[0].data();
                     const lastMoodDate = lastMood.timestamp.toDate();
                     lastMoodDate.setHours(0, 0, 0, 0);
                     
                     if (lastMoodDate.getTime() === today.getTime()) {
                        showNotification(
                           'Ya registraste tu estado de ánimo hoy',
                           'Puedes registrar un nuevo estado de ánimo mañana.',
                           'error'
                        );
                        this.value = '';
                        return;
                     }
                  }
                  
                  const moodData = {
                     mood: moodText,
                     userId: user.uid,
                     timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  };
                  
                  console.log('Intentando guardar datos:', moodData);
                  
                  // Guardar en Firestore
                  const docRef = await db.collection('moods').add(moodData);
                  console.log('Documento guardado con ID:', docRef.id);
                  
                  // Verificar que se guardó correctamente
                  const savedDoc = await docRef.get();
                  if (!savedDoc.exists) {
                     throw new Error('El documento no se guardó correctamente');
                  }
                  
                  console.log('Documento guardado exitosamente:', savedDoc.data());
                  
                  // Resetear el selector
                  this.value = '';
                  
                  // Actualizar la visualización
                  await updateHistoryDisplay('moods', 'mood-history');
                  
                  showNotification(
                     '¡Estado de ánimo guardado!',
                     'Gracias por compartir cómo te sientes. Recuerda que estamos aquí para ayudarte.'
                  );
               }
               console.log('=== FIN DEL EVENTO DE CAMBIO DE ESTADO DE ÁNIMO ===');
            } catch (error) {
               console.error('Error en el evento de cambio de estado de ánimo:', error);
               showNotification(
                  'Error',
                  'No se pudo guardar el estado de ánimo: ' + error.message,
                  'error'
               );
            }
         });
      </script>
      <!-- Firebase SDK -->
      <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

      <script>
         // Configuración de Firebase
         const firebaseConfig = {
            apiKey: "AIzaSyD68fPBicLjW3kD82fpWh4FX7KWQM1-IUo",
            authDomain: "app-andina-stress.firebaseapp.com",
            projectId: "app-andina-stress",
            storageBucket: "app-andina-stress.firebasestorage.app",
            appId: "1:875424308312:web:315af68422cc007f95fe2d"
         };

         // Inicializar Firebase
         firebase.initializeApp(firebaseConfig);

         // Referencias a los servicios
         const auth = firebase.auth();
         const db = firebase.firestore();

         // Función para iniciar sesión con Google
         window.loginWithGoogle = function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const authMessage = document.getElementById('auth-message');
            
            auth.signInWithPopup(provider)
               .then((result) => {
                  const user = result.user;
                  authMessage.className = 'success-message';
                  authMessage.textContent = '¡Inicio de sesión exitoso!';
                  console.log('Usuario de Google:', user);
                  
                  // Asegurarnos de que el usuario esté completamente autenticado
                  return auth.currentUser.getIdToken(true);
               })
               .then(() => {
                  // Cargar el historial después de asegurar la autenticación
                  updateHistoryDisplay('moods', 'mood-history').catch(error => {
                     console.error('Error al cargar estados de ánimo:', error);
                  });
                  updateHistoryDisplay('goals', 'goal-history').catch(error => {
                     console.error('Error al cargar metas:', error);
                  });
               })
               .catch((error) => {
                  authMessage.className = 'error-message';
                  if (error.code === 'auth/popup-closed-by-user') {
                     authMessage.textContent = 'El inicio de sesión fue cancelado';
                  } else if (error.code === 'auth/unauthorized-domain') {
                     authMessage.textContent = 'Este dominio no está autorizado para iniciar sesión';
                  } else {
                     authMessage.textContent = error.message;
                  }
                  console.error('Error en la autenticación:', error);
               });
         }

         // Función para cerrar sesión
         window.logout = function() {
            auth.signOut()
               .then(() => {
                  console.log('Sesión cerrada exitosamente');
               })
               .catch((error) => {
                  console.error('Error al cerrar sesión:', error);
               });
         }

         // Función para guardar datos en Firestore
         async function saveToFirestore(collection, data) {
            try {
               const user = auth.currentUser;
               if (!user) {
                  throw new Error('Usuario no autenticado');
               }

               console.log('=== INICIO DEL GUARDADO ===');
               console.log('Guardando datos en', collection, ':', data);
               console.log('Usuario actual:', user.uid);

               const docData = {
                  ...data,
                  userId: user.uid,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
               };

               console.log('Datos a guardar:', docData);

               // Intentar guardar el documento
               const docRef = await db.collection(collection).add(docData);
               console.log('Documento guardado con ID:', docRef.id);

               // Verificar que el documento se guardó correctamente
               const savedDoc = await docRef.get();
               if (!savedDoc.exists) {
                  throw new Error('El documento no se guardó correctamente');
               }

               const savedData = savedDoc.data();
               console.log('Documento guardado:', savedData);
               console.log('=== FIN DEL GUARDADO ===');

               return docRef.id;
            } catch (error) {
               console.error('Error al guardar en Firestore:', error);
               throw error;
            }
         }

         // Función para obtener datos de Firestore
         async function getFromFirestore(collection) {
            try {
               const user = auth.currentUser;
               if (!user) {
                  throw new Error('Usuario no autenticado');
               }

               console.log('=== INICIO DE LA CONSULTA ===');
               console.log('Consultando Firestore...');
               console.log('Colección:', collection);
               console.log('Usuario ID:', user.uid);

               // Realizar la consulta
               const query = db.collection(collection)
                  .where('userId', '==', user.uid)
                  .orderBy('timestamp', 'desc');
               
               console.log('Ejecutando consulta...');
               const snapshot = await query.get();
               console.log('Snapshot vacío?', snapshot.empty);
               console.log('Número de documentos:', snapshot.size);

               if (!snapshot.empty) {
                  snapshot.forEach(doc => {
                     console.log('Documento encontrado:', doc.id, doc.data());
                  });
               }

               const data = snapshot.docs.map(doc => {
                  const docData = doc.data();
                  return {
                     id: doc.id,
                     ...docData
                  };
               });

               console.log('Datos procesados:', data);
               console.log('=== FIN DE LA CONSULTA ===');
               return data;
            } catch (error) {
               console.error('Error al obtener de Firestore:', error);
               throw error;
            }
         }

         // Función para guardar el estado de ánimo
         async function saveMood(mood) {
            try {
               console.log('=== INICIO GUARDAR ESTADO DE ÁNIMO ===');
               console.log('Intentando guardar estado de ánimo:', mood);
               
               const user = auth.currentUser;
               if (!user) {
                  throw new Error('No hay usuario autenticado');
               }
               
               const moodData = {
                  mood: mood,
                  userId: user.uid,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
               };
               
               console.log('Intentando guardar datos:', moodData);
               
               const docRef = await db.collection('moods').add(moodData);
               console.log('Documento guardado con ID:', docRef.id);
               
               const savedDoc = await docRef.get();
               if (!savedDoc.exists) {
                  throw new Error('El documento no se guardó correctamente');
               }
               
               console.log('Documento guardado exitosamente:', savedDoc.data());
               
               await updateHistoryDisplay('moods', 'mood-history');
               console.log('Historial actualizado');
               
               showNotification(
                  '¡Estado de ánimo guardado!',
                  'Gracias por compartir cómo te sientes. Recuerda que estamos aquí para ayudarte.'
               );
            } catch (error) {
               console.error('Error al guardar el estado de ánimo:', error);
               showNotification(
                  'Error',
                  'No se pudo guardar el estado de ánimo: ' + error.message,
                  'error'
               );
            }
         }

         // Función para guardar una meta
         async function saveGoal(goal) {
            try {
               console.log('Intentando guardar meta:', goal);
               const docId = await saveToFirestore('goals', { goal });
               console.log('Meta guardada exitosamente con ID:', docId);
               
               await updateHistoryDisplay('goals', 'goal-history');
               console.log('Historial actualizado');
               
               showNotification(
                  '¡Meta guardada!',
                  'Tu meta ha sido guardada exitosamente.'
               );
            } catch (error) {
               console.error('Error al guardar la meta:', error);
               showNotification(
                  'Error',
                  'No se pudo guardar la meta: ' + error.message,
                  'error'
               );
            }
         }

         // Cargar el historial cuando el usuario inicie sesión
         auth.onAuthStateChanged((user) => {
            const authContainer = document.getElementById('auth-container');
            const appContent = document.getElementById('app-content');
            const userEmail = document.getElementById('user-email');

            if (user) {
               console.log('Usuario autenticado:', user.email);
               // Usuario ha iniciado sesión
               authContainer.style.display = 'none';
               appContent.style.display = 'block';
               if (userEmail) {
                  userEmail.textContent = user.email;
               }
               
               // Cargar el historial inmediatamente
               updateHistoryDisplay('moods', 'mood-history').catch(error => {
                  console.error('Error al cargar estados de ánimo:', error);
               });
               updateHistoryDisplay('goals', 'goal-history').catch(error => {
                  console.error('Error al cargar metas:', error);
               });
            } else {
               console.log('No hay usuario autenticado');
               // Usuario ha cerrado sesión
               authContainer.style.display = 'block';
               appContent.style.display = 'none';
            }
         });

         // Función para actualizar el historial
         async function updateHistoryDisplay(collection, elementId) {
            try {
               const user = auth.currentUser;
               if (!user) {
                  console.log('No hay usuario autenticado, esperando...');
                  return;
               }

               console.log('Obteniendo datos para:', collection, 'usuario:', user.email);
               const data = await getFromFirestore(collection);
               console.log('Datos obtenidos:', data);
               
               const historyElement = document.getElementById(elementId);
               if (historyElement) {
                  historyElement.innerHTML = data.map(item => {
                     const date = item.timestamp ? new Date(item.timestamp.toDate()).toLocaleDateString() : 'Fecha no disponible';
                     return `
                        <div class="history-item d-flex justify-content-between align-items-center">
                           <span>${collection === 'moods' ? item.mood : item.goal}</span>
                           <small class="text-muted">${date}</small>
                        </div>
                     `;
                  }).join('');
               }
            } catch (error) {
               console.error('Error al actualizar el historial:', error);
               throw error;
            }
         }

         // Función para eliminar un elemento
         async function deleteItem(collection, docId) {
            try {
               await deleteFromFirestore(collection, docId);
               updateHistoryDisplay(collection, `${collection}-history`);
            } catch (error) {
               console.error('Error al eliminar el elemento:', error);
               alert('Error al eliminar el elemento');
            }
         }

         // Función para limpiar todas las metas
         async function clearAllGoals() {
            try {
               const goals = await getFromFirestore('goals');
               for (const goal of goals) {
                  await deleteFromFirestore('goals', goal.id);
               }
               updateHistoryDisplay('goals', 'goal-history');
               alert('Todas las metas han sido eliminadas');
            } catch (error) {
               console.error('Error al limpiar las metas:', error);
               alert('Error al limpiar las metas');
            }
         }

         // Actualizar los event listeners para usar las nuevas funciones
         document.getElementById('save-goal').addEventListener('click', function() {
            const goal = document.getElementById('goal-input').value;
            if (goal) {
               saveGoal(goal);
               document.getElementById('goal-input').value = '';
            } else {
               showNotification(
                  'Campo vacío',
                  'Por favor, ingresa una meta antes de guardar.',
                  'error'
               );
            }
         });
      </script>

      <!-- Modal para Eliminar Contraseña -->
      <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="resetPasswordModalLabel">Eliminar Contraseña</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <form id="resetPasswordForm">
                     <div class="mb-3">
                        <label for="currentPassword" class="form-label">Contraseña Actual</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                     </div>
                     <div class="mb-3">
                        <label for="newPassword" class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="newPassword" required>
                     </div>
                     <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Confirmar Nueva Contraseña</label>
                        <input type="password" class="form-control" id="confirmNewPassword" required>
                     </div>
                  </form>
                  <div id="resetPasswordMessage" class="alert" style="display: none;"></div>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="resetPassword()">Cambiar Contraseña</button>
               </div>
            </div>
         </div>
      </div>

      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         // Función para mostrar el modal de cambio de contraseña
         window.showResetPasswordForm = function() {
            const resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            resetPasswordModal.show();
         }

         // Función para cambiar la contraseña
         window.resetPassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const messageDiv = document.getElementById('resetPasswordMessage');

            // Validar que las contraseñas coincidan
            if (newPassword !== confirmNewPassword) {
               messageDiv.className = 'alert alert-danger';
               messageDiv.textContent = 'Las nuevas contraseñas no coinciden';
               messageDiv.style.display = 'block';
               return;
            }

            const user = auth.currentUser;
            if (!user) {
               messageDiv.className = 'alert alert-danger';
               messageDiv.textContent = 'No hay usuario autenticado';
               messageDiv.style.display = 'block';
               return;
            }

            // Reautenticar al usuario antes de cambiar la contraseña
            const credential = firebase.auth.EmailAuthProvider.credential(
               user.email,
               currentPassword
            );

            user.reauthenticateWithCredential(credential)
               .then(() => {
                  // Cambiar la contraseña
                  return user.updatePassword(newPassword);
               })
               .then(() => {
                  messageDiv.className = 'alert alert-success';
                  messageDiv.textContent = 'Contraseña actualizada exitosamente';
                  messageDiv.style.display = 'block';
                  
                  // Limpiar el formulario
                  document.getElementById('resetPasswordForm').reset();
                  
                  // Cerrar el modal después de 2 segundos
                  setTimeout(() => {
                     const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                     modal.hide();
                  }, 2000);
               })
               .catch((error) => {
                  messageDiv.className = 'alert alert-danger';
                  messageDiv.textContent = error.message;
                  messageDiv.style.display = 'block';
               });
         }
      </script>

      <script>
         // Función para mostrar notificaciones
         function showNotification(title, message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            notification.innerHTML = `
               <i class="fa ${icon}"></i>
               <div class="notification-content">
                  <div class="notification-title">${title}</div>
                  <div class="notification-message">${message}</div>
               </div>
            `;
            
            container.appendChild(notification);
            
            // Eliminar la notificación después de 3 segundos
            setTimeout(() => {
               notification.style.animation = 'fadeOut 0.3s ease-out';
               setTimeout(() => {
                  container.removeChild(notification);
               }, 300);
            }, 3000);
         }
      </script>
   </body>
</html> 